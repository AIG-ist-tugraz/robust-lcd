# Dockerfile.eval - Full image for running evaluations (for researchers)
# Usage:
#   docker build -f Dockerfile.eval -t gc-seeker-eval .
#
# Run Python evaluation scripts:
#   docker run --rm \
#     -v "$PWD/test-scripts":/app/test-scripts \
#     -v "$PWD/data/kb":/app/data/kb \
#     gc-seeker-eval \
#     python3 test-scripts/aaai/eval_script.py -cfg test-scripts/aaai/conf/busybox_eval_script.toml
#
# Run JAR directly:
#   docker run --rm \
#     -v "$PWD/conf":/app/conf \
#     -v "$PWD/data":/app/data \
#     gc-seeker-eval \
#     java -jar /app/target/gc_seeker-jar-with-dependencies.jar -cfg /app/conf/gc_seeker.cfg

# Stage 1 — Build with Maven (JDK 21)
FROM maven:3.9.9-eclipse-temurin-21 AS builder

WORKDIR /workspace

COPY pom.xml ./
COPY lib ./lib

RUN mvn -B -e -q validate dependency:go-offline --no-transfer-progress

COPY src ./src

RUN mvn -B -e -DskipTests package --no-transfer-progress


# Stage 2 — Runtime with JRE 21 + Python 3
FROM eclipse-temurin:21-jre AS runtime

RUN apt-get update \
    && apt-get install -y --no-install-recommends \
       python3 \
       python3-pip \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy JAR file
COPY --from=builder /workspace/target/gc_seeker-jar-with-dependencies.jar /app/target/

# Install Python dependencies (--break-system-packages is safe in isolated container)
COPY test-scripts/aaai/requirements.txt /tmp/requirements.txt
RUN python3 -m pip install --no-cache-dir --break-system-packages -r /tmp/requirements.txt \
    && rm /tmp/requirements.txt

# Default: show help
CMD ["echo", "Usage: docker run gc-seeker-eval <command>. See Dockerfile.eval for examples."]
